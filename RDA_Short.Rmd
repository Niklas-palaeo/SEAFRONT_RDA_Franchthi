---
title: "RDA Analysis Method"
author: "Niklas Hausmann"
date: "Today"
output: pdf_document
---

# Libraries 
```{r Libraries,echo=FALSE,message = FALSE,warning = FALSE}
knitr::opts_chunk$set(echo=FALSE,message = FALSE,warning = FALSE)

{
  pacman::p_load(
    here,
    janitor,
    tidyverse,ggpubr,broom,
    cowplot,ggx,vegan,
    patchwork,
    RColorBrewer) 
  
  theme_set(theme_cowplot())
  chron_colours <- c("#7D3C98","#9B30FF",  "darkgreen", "#74C365", "#FF8C00","#FFD700")
  
  }
```

# Data
```{r}

rds_files <- c("Bot", "Corrs_Bot", "Corrs_Fauna", "D18O", "D18O_WSr", 
               "Fauna", "Filtered_Bot", "Filtered_D18O_Bot", "Filtered_D18O_Fauna", 
               "Filtered_Fauna", "Joined_D18O_Bot", "Joined_D18O_Fauna")


for (file in rds_files) {
  full_file_path <- here("data", "pre-formatted dataframes", paste0(file, ".rds"))

  assign(file, readRDS(full_file_path))
}

```



RDA analysis will tell you whether and if yes how the variability (inertia) of the faunal or botanical data is correlated with or explained by the environmental data. You can then play around with the environmental factors using the equations or you can pick out the most important ones when running all factors and show in more detail how they relate to the faunal and botanical species using the scatterplots and correlation tests (R,R2 and p). 
Using ths CorrsFauna or CorrsBot dataframe you can look at what species are mostly affected by environmental change and also highlight those using scatterplots.

This should give you enough to discuss the impact of climatic variability or temperature extremes onto human subsistence at Franchthi.
# RDA
## Faunal Analysis
```{r}
All_RDA <- rda(Filtered_Fauna,Filtered_D18O_Fauna)
```


```{r}
All_RDA
ordiplot(All_RDA,type = "text")

# Scaling 1: Distances among objects reflect their similarities	
ordiplot(All_RDA, scaling = 1, type = "text")

# Scaling 2: Angles between variables reflect their correlation
ordiplot(All_RDA, scaling = 2, type = "text")

MinMax_RDA <- rda(Filtered_Fauna ~ se+range+ + Winter_Temp, data=Filtered_D18O_Fauna)
MinMax_RDA
ordiplot(MinMax_RDA)

SummerSE_RDA <- rda(Filtered_Fauna ~ se + Summer_Temp, data=Filtered_D18O_Fauna)
SummerSE_RDA
ordiplot(SummerSE_RDA)

WinterSE_RDA <- rda(Filtered_Fauna ~ se + Winter_Temp, data=Filtered_D18O_Fauna)
WinterSE_RDA
ordiplot(WinterSE_RDA)

```


## Botanical analysis
```{r}
All_RDA <- rda(Filtered_Bot,Filtered_D18O_Bot)
All_RDA
ordiplot(All_RDA)


MinMax_RDA <- rda(Filtered_Bot ~ Summer_Temp + Winter_Temp, data=Filtered_D18O_Bot)
MinMax_RDA
ordiplot(MinMax_RDA)

SummerSE_RDA <- rda(Filtered_Bot ~ se + range+Summer_Temp, data=Filtered_D18O_Bot)
SummerSE_RDA
ordiplot(SummerSE_RDA)

WinterSE_RDA <- rda(Filtered_Bot ~ se + Winter_Temp, data=Filtered_D18O_Bot)
WinterSE_RDA
ordiplot(WinterSE_RDA)


```



#Diversity indices
## Fauna
```{r}
########
# Calculate Shannon diversity

Joined_D18O_Fauna %>% 
  left_join(tibble(trenchunit = names(diversity(Filtered_Fauna, index = "shannon")), 
                                   shannon_diversity = diversity(Filtered_Fauna, index = "shannon")),by="trenchunit") %>% 
left_join(tibble(trenchunit = names(diversity(Filtered_Fauna, index = "simpson")), 
                                   simpson_diversity = diversity(Filtered_Fauna, index = "simpson")),by="trenchunit") %>% 
  select(-species,-nisp,-env_data,-env_values) %>%
  pivot_longer(cols = c("shannon_diversity","simpson_diversity"),names_to = "diversity_index",values_to = "diversity_values") %>% 
  unique() %>% 
  # filter(env_data=="Winter_Temp") %>% 
  # filter(diversity_index=="simpson_diversity") %>% 
  ggplot()+
  aes(chronology,diversity_values, col=chronology,fill=chronology)+
  geom_boxplot(alpha=0.2,varwidth = TRUE)+
  geom_jitter()+
  scale_colour_manual(values = chron_colours) + 
  scale_fill_manual(values = chron_colours) + 
  facet_wrap(~diversity_index,scales = "free")
    labs(title="simpson_diversity", x="Environmental Values", y="Diversity values", col="")
  




```

